<html>
<head>
<title>Low-Pixel 3D</title>
</head>
<style type='text/css'>
  html 
  {
    image-rendering:optimizeSpeed;
    image-rendering:optimize-contrast;
    image-rendering:-webkit-optimize-contrast;
    image-rendering:-moz-crisp-edges;
  }
</style>

<script type='text/javascript' src='GL/utils/gl-matrix.js'></script>
<script type='text/javascript' src='GL/utils/webgl-utils.js'></script>
<script type='text/javascript' src='GL/GLMan.js'></script>
<script type='text/javascript' src='GL/AssetMan.js'></script>
<script type='text/javascript' src='GL/XGLProgram.js'></script>
<script type='text/javascript' src='GL/GeoGLProgram.js'></script>
<script type='text/javascript' src='GL/LowResTexGLProgram.js'></script>
<script type='text/javascript' src='GL/HighResTexGLProgram.js'></script>
<script type='text/javascript' src='GL/HudGLProgram.js'></script>
<script type='text/javascript' src='GL/XGLGeo.js'></script>
<script type='text/javascript' src='GL/XGLLight.js'></script>
<script type='text/javascript' src='GL/TileGLGeo.js'></script>
<script type='text/javascript' src='utils/AsyncLoaderMan.js'></script>
<script type='text/javascript' src='utils/InputMan.js'></script>

<script type='text/javascript'>
//Managers
var glm;//GLMan
var am;//AssetMan
var im;//InputMan

//Gameloop variables
var tick_tock;
var stamps = [];
var fps;
var fpsDisplayUpdateCountdown;
var delta;

function loadContent()
{
  //Init the men
  glm = new GLMan(640, 320, glReady);
  am  = new AssetMan(assetsReady);
  im  = new InputMan();
};

function glReady()     { if(am.ready)  init(); };
function assetsReady() { if(glm.ready) init(); };

function init()
{
  //push content to GL
  am.commitAssetsToGL(glm);
  //push canvas to DOM
  document.getElementById('render_area').insertBefore(glm.canvas,document.getElementById('shadow'));

  //Init game loop variables
  tick_tock = true;
  stamps[true]  = new Date().getTime();
  stamps[false] = new Date().getTime();
  fps = 0;
  fpsDisplayUpdateCountdown = 10;

  //Move the lights
  mat4.translate(am.lightbox1.mMat,[0,1,0]);
  am.light1.setPosition(0,1,0);
  mat4.translate(am.lightbox2.mMat,[2,0,2]);
  am.light2.setPosition(2,0,2);

  //Start the tick_tock
  requestAnimFrame(tick,glm.canvas);
}


var playerX   = 0;
var playerZ   = 10;
var playerDir = 0; //Radians: 0 = 2pi = facing -Z
var playerVel = 0; //+ = forward, - = backward
var playerSSV = 0; //Side-Strafe-Velocity (+ = left, - = right);
var yWave = 0;
var yMag = 6;
function tick()
{
  requestAnimFrame(tick,glm.canvas);

  //Reset absolute positions
  mat4.identity(glm.geoProgram.camMatData);
  mat4.identity(am.arms.mMat);
  //Reset delta vars
  playerVel = 0;
  playerSSV = 0;
  
  //Read lateral movement
  if(im.right)        playerDir -= 0.03;
  if(im.left)         playerDir += 0.03;
  if(im.up   || im.w) playerVel += 0.3;
  if(im.down || im.s) playerVel -= 0.3;
  if(im.a)            playerSSV += 0.15;
  if(im.d)            playerSSV -= 0.15;

  //Calculate Back/Forth
  playerX -= playerVel * Math.sin(playerDir);
  playerZ -= playerVel * Math.cos(playerDir);
  //Calculate Side/Side
  playerX -= playerSSV * Math.sin(playerDir+(Math.PI/2));
  playerZ -= playerSSV * Math.cos(playerDir+(Math.PI/2));
  //Calculate y movement
  yWave += 0.1;
  yMag = 16;
  if(playerVel != 0) { yWave += 0.15; yMag = 10; }
  if(playerSSV != 0) yWave += 0.05;

  //Plug in lateral movement
  mat4.translate(glm.geoProgram.camMatData,[0,0,playerZ]);  mat4.translate(am.arms.mMat,[0,0,playerZ]);
  mat4.translate(glm.geoProgram.camMatData,[playerX,0,0]);  mat4.translate(am.arms.mMat,[playerX,0,0]);
  mat4.rotate(glm.geoProgram.camMatData,playerDir,[0,1,0]); mat4.rotate(am.arms.mMat,playerDir,[0,1,0]);
  //Plug in y movement
  mat4.translate(am.arms.mMat,[0,Math.sin(yWave)/yMag,0]);
  mat4.translate(glm.geoProgram.camMatData,[0,Math.sin(yWave+0.4)/yMag,0]);

  //Render the updated data
  glm.draw();
  
  //Game loop/framerate vars
  delta = ((stamps[tick_tock] = new Date().getTime()) - stamps[(tick_tock = !tick_tock)]);
  fpsDisplayUpdateCountdown--;
  if(fpsDisplayUpdateCountdown == 0)
  {
    fps = Math.round(1000/delta);
    am.fps1.tileIndex = fps%10;
    am.fps10.tileIndex = (fps-am.fps1.tileIndex)/10;
    fpsDisplayUpdatecountdown = 10;
  }
}

window.addEventListener('load', loadContent, false);
</script>
<body style='background-color:#252529'>
<div id='render_area' style='width:640px; margin:10px auto; position:relative; top:50px;'>
  <img id='shadow' src='assets/images/shadow.png' style='display:block;'></img>
</div>
<div id="debug" style="color:white; position:absolute; top:0px;"></div>
</body>
</html>
